/**
 * sofa-search-service - v0.5.0 - 2014-09-10
 * http://www.sofa.io
 *
 * Copyright (c) 2014 CouchCommerce GmbH (http://www.couchcommerce.com / http://www.sofa.io) and other contributors
 * THIS SOFTWARE CONTAINS COMPONENTS OF THE SOFA.IO COUCHCOMMERCE SDK (WWW.SOFA.IO).
 * IT IS PROVIDED UNDER THE LICENSE TERMS OF THE ATTACHED LICENSE.TXT.
 */
!function(a){"use strict";a.define("sofa.SearchRequestResolver",function(a,b){var c=b.get("storeCode"),d=b.get("searchUrl")+"?callback=JSON_CALLBACK&len=100",e=function(a){var b=a.split("").reverse().join("");return"(text:"+a+"* OR reverse_text:"+b+"*) AND storeCode:"+c},f=function(a){return a.replace(/[áàâä]/g,"a").replace(/[úùûü]/g,"u").replace(/[óòôö]/g,"o").replace(/[éèêë]/g,"e").replace(/[ß]/g,"ss")};return function(b){return a({method:"JSONP",url:d,params:{q:e(f(b)),fetch:"text, categoryUrlKey, categoryOriginFullUrl, categoryName, productUrlKey, productOriginFullUrl, productImageUrl"}})}}),a.define("sofa.SearchResultResolver",function(){return function(a){var b=a.data.results,c=b.reduce(function(a,b){if(!a[b.categoryUrlKey]){var c=a[b.categoryUrlKey]={groupKey:b.categoryUrlKey,groupOriginFullUrl:b.categoryOriginFullUrl,groupText:b.categoryName,items:[]};a.items.push(c)}return a[b.categoryUrlKey].items.push(b),a},{items:[]});a.data.groupedResults=c.items}}),a.define("sofa.SearchService",function(b,c,d,e){var f={},g=null,h=b.get("searchDebounceMs",300),i=new a.SearchRequestResolver(c,b),j=new a.SearchResultResolver(c,d);f.search=function(a,b){var c=d.defer();return l(c,a,b),c.promise};var k=function(b,c,d){g=a.Util.createGuid();var f=g;return c?i(c).then(function(a){f===g&&(d&&j(a),b.resolve(a))}):b.resolve({data:{results:[],groupedResults:[]}}),e&&e(),b.promise},l=a.Util.debounce(k,h);return f})}(sofa);